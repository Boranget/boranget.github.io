---
title: tcp
date: 2023-07-04 09:50:30
updated: 2024-01-31 16:40:19
tags:
  - tcp
categories:
  - 笔记
---

# TCP三次握手

**ACK和ack**

- ACK：TCP协议中的一个标志位，标识是否对上一个包进行了确认操作
- ack：32位确认号，等于上一个包的序列号seq+1

**此外**

- SYN：同步标志位，用于建立会话连接
- seq：32位序号，通过该序号确认发送的数据是有序的

**步骤**

1. 第一次，客户端将SYN位置1，表示开始建立同步会话。产生一个随机数x作为序列号seq，保存至TCP报文首部的序列号字段中。知名客户端打算连接的端口，将该数据包发送给服务器端，接着客户端进入SYN_SENT状态，等待服务端的响应。

2. 第二次，服务端接收到数据包，先检查SYN标志位，发现为1，得知客户端要建立链接。于是服务端构造数据包：将SYN位和ACK位都置为1，表示当前要建立同步连接且对上一个包进行了确认，将ack字段填充为x+1，接着随机产生一个随机数y填入seq字段，发送给客户端，服务器进入SYN_Rcvd状态。

3. 第三次，客户端检查ack字段是否为x+1，若接收到了，则将ack字段置为y+1发送给服务端，服务端接收后检查ack字段为y+1则建立连接。此时客户端和服务端进入ESTABLISHED状态，开始传输数据。

**为何要进行三次握手**

服务端接收到客户端的数据包之后，有可能是由于延迟送达的很早之前的数据包，所以需要确认一下客户端是否还要建立连接，如果不确认而是收到连接请求包就建立连接，但客户端却不再发送，会造成资源浪费。

- A：B我要建立连接
- B：A，我刚收到你的消息，你还要连吗？
- A：要的要的

**四次挥手**

- A：你把我断了吧
- B：好的断了
- B：你把我也断了吧
- A：好的断了

至于为何B不在第二部确认断掉连接的同时告诉A把自己断掉，是因为TCP是全双工的模式，故后续有可能B还要给A发送数据，所以要分开确认。