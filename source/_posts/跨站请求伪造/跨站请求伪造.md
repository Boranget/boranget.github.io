---
title: 跨站请求伪造
date: 2023-11-09 10:21:19
updated: 2024-01-02 16:40:19
tags:
  - 跨站请求伪造
categories:
  - 笔记
---

# 参考资料

[Web漏洞之CSRF(跨站请求伪造漏洞）详解 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/398601816)

# 介绍

跨站请求伪造，在用户访问B网站时，B网站中有通往A网站的攻击连接，用户点击后会在不知情中对A网站进行操作。

若用户在A网站中先进行登录，A网站为了保存用户的登录状态，会向浏览器中存储cookie。此时若用户在没有关闭浏览器的情况下，访问的B网站，点击了B网站中的攻击连接，B网站会发起一个向A网站的操作并携带A网站的cookie，模拟登录用户的操作。

**条件**

- 用户访问A并产生了cookie
- 用户在没有关闭浏览器的情况下访问了网站B

# 防御

## 验证请求中的Referer字段

Referer字段为浏览器产生的，表示该请求的来源，服务端可通过该字段判断请求是否从A网站发起的，若是通过B网站发起的请求，则Referer会指向B，则服务器可拒绝请求。

优点：操作简单，只需要在处理请求之前先验证Referer头即可，往后的业务基本无感。

缺点：安全性依赖于浏览器的安全性，若浏览器构造的Referer字段被攻击，则此方法无效，且由于有些用户认为Referer字段侵犯了用户的隐私权，故浏览器可以设置不发送Referer，若服务端获取不到Referer则会拒绝请求。且某些浏览器如ie6，Referer值可以被篡改。

## 请求参数中添加token

**Anti-CSRF token**

A服务器生成一个token并保存，同时存入浏览器的cookie中，当前页面中使用js，遍历的将当前页面中所有的href等可能发起请求的地方添加参数，值为这个token，这样用户在发起请求时会自动携带该token。而第B网站由于同源策略无法访问A下的cookie，无法携带这个参数。

但若B拥有者在A网站发表了带攻击地址的评论或者帖子，A网站可能也会在该链接上添加当前用户的token，如果用户在A网站中点击了到B网站的链接，此时B网站便可获取该用户的token从而进行攻击。可以在添加参数时判断是否连接到本站。但B网站也可通过获取到用户请求后查看Refer头来获取token。

## HTTP头中自定义属性并验证

与请求参数中添加token的方法类似，只不过是通过请求手段添加请求头。