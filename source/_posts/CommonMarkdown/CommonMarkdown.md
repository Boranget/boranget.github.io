---

 title: CommonMarkdown
date: 2024-11-17 21:35:19
updated: 2024-11-17 21:35:19
tags:
  - markdown
categories:
  - notes
---

# 参考资料

https://spec.commonmark.org/0.31.2/

# 字符和行

## 行/空行

- line ending：由换行符（U+000A）和回车符（U+000D）组成，如换行不加回车，回车不加换行，以及回车跟着换行
- line：0到多个字符（除line ending之外），后面跟着line ending
- blank line：一个行不包含任何字符或只包含空格（U+0020）或者tab（U+0009）

## 特殊字符

- 空格：（U+0020）
- tab：（U+0009）
- ASCII控制字符：a character between `U+0000–1F` (both including) or `U+007F`.
- ASCII标点符号：`!`, `"`, `#`, `$`, `%`, `&`, `'`, `(`, `)`, `*`, `+`, `,`, `-`, `.`, `/` (U+0021–2F), `:`, `;`, `<`, `=`, `>`, `?`, `@` (U+003A–0040), `[`, `\`, `]`, `^`, `_`, \` (U+005B–0060), `{`, `|`, `}`, or `~` (U+007B–007E).
- Unicode标点符号：a character in the Unicode `P` (puncuation) or `S` (symbol) general categories.
- Unicode空白字符：a character in the Unicode `Zs` general category, or a tab (`U+0009`), line feed (`U+000A`), form feed (`U+000C`), or carriage return (`U+000D`).
- tab的行为可以被理解为四个空格，但作为文本解析时还是tab
- 出于安全原因，应将文档中的null（U+0000）替换为替换字符（U+FFFD）

## 转义字符

- 任何ascii标点符号应该加上转义斜杠，除此之外的字符之前的转义斜杠应该被解析为文本斜杠。
- 被转义的字符应该作为纯文本，不再有md中符号的含义，
- 转义斜杠可以被转义斜杠转义，
- 行末尾添加一个转义斜杠会作为硬换行，
- 转义斜杠在代码块、代码段中、自动链接中或者原生HTML中不起作用
- 转义字符在其他内容中比如URL，link title、link reference 、以及围栏代码块的info string中是起作用的

## html实体和字符引用

- 合法的实体和字符引用可以在一些地方使用
- 实体和字符引用在代码块或者代码段（行内代码）中不被承认
- 实体和字符引用如果是不可参与md文档结构解析
- html实体为`&`+HTML实体名+`;`：https://html.spec.whatwg.org/entities.json
- 十进制字符引用：`&#`+（1-7位的）十进制编码+`;`，非法的unicode会被替换为替换字符
- 十六进制字符引用：`&#`+`X`或`x`+（1-6位的）十六进制编码+`;`
- 非法的字符引用会被替换为替换字符，但是非字符引用用原文显示
- 在html中，允许实体没有分号结尾，但是在md中不建议进行解析
- 不在html实体列表中的字符串不被解析
- 实体和字符引用在代码块，代码段中不解析
- 注意解析到URL中时会被URL编码
- 实体和字符引用解析后的结构符号不会有md符号的作用

# 块类型

## 叶子块 Leaf blocks

### 分割线Thematic breaks

- 开头最多能有三个空格
- 至少三个符号`-_*`
- 行尾可跟任意数量空格。
- 需要使用同意符号，不能混用
- 符号中间允许有任意数量空格或者tab分隔。
- 行不能有其他符号。
- 分割线会结束段落，上下无需空行。
- 如果使用中划线，会优先解析为被动标题（setext heading），想避免可以用其他符号。

### 标题 ATX heading

- 开头带1-6个`#`，可选的任意数量的关闭符号`#`（pound sign）
- 行头`#`后需要跟至少一个空格或者tab，除非标题为空
- 行尾`#`（如果有）前需要跟至少一个空格或者tab，其后只能跟空格或者tab，如果跟了其他内容则会作为标题内容处理
- 被转义的`#`不作为关闭序列
- 行开头允许最多有三个空格
- 标题在渲染内联结构之前会先trip空格
- 标题层级取决于开头`#`数量
- 标题会结束段落，上下无需空行
- 标题可为空

### 被动标题 Setext heading

- 被动标题中不能有空行
- 行开头允许最多有三个空格
- 下一行为被动标题下划线结构
- 该行不能为以下结构：
    - 围栏代码块
    - 标题
    - 分割线
    - 列表元素
    - html块
- 被动标题下划线
    - 被动标题下划线由`=-`两种符号组成，长度任意（1-∞）
    - 行开头允许最多有三个空格
    - 行结尾可以有任意数量的空格或者tab
    - `=`为一级标题，`-`为二级标题
- 标题的内容为解析了内联结构后的内容
- 一般标题前无需空行，但被动标题不能结束段落，所以当一个被动标题跟在段落后时，需要在段落后先跟一个空行，由于以上原因，被动标题可以有多行。
- 被动标题的内容与下划线不需要对齐（三个空格以下的缩进）
- 下划线内不能有空格或者tab
- 被动标题内容末尾的空格不会导致硬换行，斜杠也不会
- 由于块结构优先于内联，所以如果多行的内联代码框住了被动标题的整个结构，会优先解析为被动标题，其余内联结构同理。
- 被动标题下划线不能存在于列表或者引用的懒换行中
- 被动标题不能为空，否则会变为分割线
- **被动标题不能被解析为除段落外的其他块元素**，否则被动标题下划线会解析为分割线
- 被动标题内容开头如果有特殊符号可以使用转义符转义
- 可以通过添加空行的方式避免不必要的被动标题形成
- 被动标题符号出现后（确认start），会替换当前容器

### 缩进代码块

- 缩进代码块由一个或多个由空行分隔的缩进代码块构成
- 一个缩进代码块由一系列非空行组成，每行开头需要有至少四个空格的缩进
- 代码块内容为去掉四个缩进空格后的文本原文，包括行尾换行或回车
- 缩进代码块没有信息字符串（相对于围栏代码块
- 缩进代码块无法结束段落，故在段落后缩进代码块之前必须有一个空行，反过来（缩进代码块后跟段落）不需要。
- 当与列表项同时存在时，优先解析为列表项（列表项会有忽略空行续的情况
- 只要收尾是由四个空格缩进的结构，则中间所有的空白行都会包括在同一个代码块内
- 缩进代码块无法结束段落
- 缩进代码块可以直接跟在（无需空行）其他块结构后或前
- 任何缩进小于四个空格的非空行都会立即结束代码块，故段落可直接跟在缩进代码块后
- 缩进代码块之后或者之前的空行不包括在缩进代码块内

### 围栏代码块

- 代码围栏由至少三个反引号或者波浪号组成，两种符合不可混用，且需要连续，中间不可穿
- 插空格或者其他符号
- 代码围栏最多能有三个空格缩进
- 代码围栏后面可以跟info string，info string中不应该跟任何反引号，否则会被解析为行内代码（如果启动符号为波浪线则info string中波浪线和反引号均可以出现）
- 围栏代码块直到碰到同样格式（同种字符，相同或者更多数量字符）的代码围栏才会结束
- 如果启动代码围栏有N个缩进，则代码内容中每行都会去掉三个空格（不足三个全去掉）
- 结束代码围栏最多能有三个缩进（缩进无需与启动代码围栏对齐），其后只能跟空格或者tab并且会被忽略。当然也没有info string一说
- 如果到文档结尾（或者引用快结尾、列表项结尾）都没找到结束代码围栏，则启动围栏后所有内容都属于代码块内容
- 围栏代码块会结束段落，且前后无需空行
- 其余块结构也可以直接跟在围栏代码块前后，无需空行
- 代码块内容以原文显示，不进行行内渲染
- info string 中的第一个单词一般作为代码块中语言的声明，通常会在code元素中添加class`language-`如`class="language-java"`
- 代码块内容可以为空

### HTML

- HTML块由启动条件和结束条件组成

- HTML代码块内，所有内容被解析为原生的HTML，包括md结构字符

- 启动条件最多能有三个缩进

- 碰到结束条件关闭该块

- 碰到文档结尾或者行内容器的末尾关闭该块

- 如果碰到其他容器块则关闭该块

- 如果在第一行便碰到了开始条件和结束条件，则块只包含一行

- 七种情况

    - 情况1
        - 启动条件：由 `<pre`, `<script`, `<style`, or `<textarea` (大小写敏感),开头的行，followed by a space, a tab, the string `>`, or the end of the line.
        - 结束条件：行包含end tag `</pre>`, `</script>`, `</style>`, or `</textarea>` (大小写敏感，不需要匹配到开始标签)
    - 情况2
        - 启动条件：行开头为`<!--`
        - 结束条件：行包含  `-->`
    - 情况3
        - 启动条件：行开头为`<?`
        - 结束条件：行包含 `?>`
    - 情况4
        - 启动条件：行开头为` <!`后面跟着一个ASCII字符
        - 结束条件：行包含 `?>`
    - 情况5
        - 启动条件：行开头为`<![CDATA[`
        - 结束条件：行包含 `]]>`
    - 情况6
        - 启动条件： 行开头为`<` or `</` followed by one of the strings (大小写敏感) `address`, `article`, `aside`, `base`, `basefont`, `blockquote`, `body`, `caption`, `center`, `col`, `colgroup`, `dd`, `details`, `dialog`, `dir`, `div`, `dl`, `dt`, `fieldset`, `figcaption`, `figure`, `footer`, `form`, `frame`, `frameset`, `h1`, `h2`, `h3`, `h4`, `h5`, `h6`, `head`, `header`, `hr`, `html`, `iframe`, `legend`, `li`, `link`, `main`, `menu`, `menuitem`, `nav`, `noframes`, `ol`, `optgroup`, `option`, `p`, `param`, `search`, `section`, `summary`, `table`, `tbody`, `td`, `tfoot`, `th`, `thead`, `title`, `tr`, `track`, `ul`，后面跟着空格或者tab或者行结束，或者  `>`,  `/>`.
        - 结束条件：一个行，后面跟着一个空行
    - 情况7
        - 启动条件：行开头为一个完整的HTML开始标签( any [tag name](https://spec.commonmark.org/0.31.2/#tag-name) other than `pre`, `script`, `style`, or `textarea`)或者一个完整的结束标签，后面跟着0个或多个空格或者tab，再往后为行结尾（end of the line）
        - 结束条件：一个行，后面跟着一个空行

- HTML块只有在碰到该种类型的结束条件是才会被关闭，所以在其中又碰到开启条件时不会关闭该块或者开启一个新的块

    ```
    <table><tr><td>
    <pre>
    **Hello**,
    
    _world_.
    </pre>
    </td></tr></table>
    //==========
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE document SYSTEM "CommonMark.dtd">
    
    <document xmlns="http://commonmark.org/xml/1.0">
      <html_block>&lt;table&gt;&lt;tr&gt;&lt;td&gt;
    &lt;pre&gt;
    **Hello**,</html_block>
      <paragraph>
        <emph>
          <text>world</text>
        </emph>
        <text>.</text>
        <softbreak />
        <html_inline>&lt;/pre&gt;</html_inline>
      </paragraph>
      <html_block>&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;</html_block>
    </document>
    ```

    

- 除了情况7外的其他HTML块都会结束段落

- 一个HTML块可以以结束标签开始

- 开放标签也并不需要关闭

- 若标签名在情况6的字符列表中，当碰到该字符串的时候（至少结尾有个分割），则开始条件已经达成，此时已经满足html块的启动条件

- 第一行的标签可以是部分的，只要在应该有空格的地方被分割

    ```
    <boranget
    name="">
    
    123
    //==========
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE document SYSTEM "CommonMark.dtd">
    
    <document xmlns="http://commonmark.org/xml/1.0">
      <paragraph>
        <html_inline>&lt;boranget
    name=&quot;&quot;&gt;</html_inline>
      </paragraph>
      <paragraph>
        <text>123</text>
      </paragraph>
    </document>
    ```

    

- 若标签名在情况6的字符列表中，开放标签并不需要完整包含到`>`，

- 如果标签名不在6列表中，则第一行中开始标签必须要完整，且该行只能有该启动标签。

- 在情况6中，开始条件不需要单独占用一个行，也可以只是行开头的部分字符。

- 情况6中，任何在没有碰到空行或者文档结尾时的内容都被包括在HTML块中

- 在情况7中，标签名可以为任何字符串，注意是标签名

- 情况7中，如果起始行不只有启动标签，则会解析为inline HTML

- 情况1-5都可以包含空行，因为他们的停止条件是固定的，直到碰到文档结尾或者引用结尾或者列表项结尾

- 结束标签可以和开始标签在同一行

- 在最后一行标签后的内容会包含在HTML块内

- 情况1-6都可以结束段落，故块前无需添加空行，但是对于6，在块结尾需要添加空行。

- 情况7无法结束段落

### 链接引用定义

- 链接标签由`[`开头，以`]`结尾

- 链接定义有两种情况，
    - 一种是被尖括号包裹的字符，其中不能保护任何未转义的尖括号，
    - 另一种是未被尖括号包裹的，其中不能包含ASCII控制字符以及空格，可以包含被转义的圆括号或者成对的圆括号
    
- 链接标题
    - 一种是被双引号包裹的字符串，可包含被转义的双引号
    - 一种是被单引号包裹的字符串，可包含被转义的单引号
    - 被圆括号包裹，可包含被转义的圆括号
    - 链接标题可分割到多行，但不能包含空行
    
    ```
    [foo]: /url "title"
    
    [foo]
    >===
    <p><a href="/url" title="title">foo</a></p>
    ```
    
    
    
- 开头最多会存在三个空格的缩进

- 链接引用定义由链接标签开头，跟着一个冒号，接着可选的空格或者tab，或者最多一个行结束，跟着一个链接定义，再跟可选的空格或者tab或者最多一个行结束，在加一个可选的链接标题，如果链接标题存在，则必须添加一个空格或者制表符在链接定义之后。

- 链接引用定义并不会解析出一个结构出来，只是会在链接定义或者图片中引用

- 链接引用定义无法结束段落，故其之前需要一个空行

- 但链接引用定义可以直接跟在其他的块元素后，不需要空行分割

- 链接引用定义可在引用之前或者之后定义

- 链接定义（第二个组成部分）不能被省略，但可以通过一个空的尖括号区间构建一个空定义

- title和定义中都可包含转义字符和转义斜杠（如果转义斜杠后非能被转义的字符，则会直接解析为转义斜杠）

- 如果有多个匹配的定义，则会采用第一个定义（先来后到，常量（无法修改）的感觉

- 标签的匹配不区分大小写

- 链接引用定义在标题后不能有除了空格或者tab外的其他字符

- 如果只有链接引用定义而没有链接引用，则链接引用定义不会对文档有影响（不会解析出任何结构

- 如果下一行不满足上一行的连续，则上面的内容单独解析

    ```
    [foo]: /url
    "title" ok
    // =======
    (上面的解析成引用定义，下面的不满足title，则单独解析)
    <p>&quot;title&quot; ok</p>
    ```

- 多个链接引用定义中间可

- 以无空行分隔

- 在块容器内的链接引用定义会影响整个文档

- 链接标签必须有内容

### 段落

- 由非空行组成
- 无法解释为其他块类型
- 渲染后为解析了其中的行内元素后的结果
- 解析时会删除每行初始和最后的空格或者制表符
- 软换行不会终止段落
- 一个或多个空行会终止段落，但多个空行并不会渲染为多个空行（一个空行也不会渲染为一个空行
- 第一行首的空格不能多于三个，但紧贴着的下面的行首空格没有限制，因为代码块不会终止段落

### 空行

- 块级元素中间的空行会被忽略，只做隔断用
- 在列表中会用来定义紧列表或松列表

## 容器块

容器块中有其他的块作为其内容，有两种基本类型的容器块：块引用和列表项，列表是列表项的元容器。

### 块引用

- 块引用标记最多可以有三个空格缩进

- 块引用标记由字符`>`，后面跟可选的一个空格缩进组成

- 如果有一系列行Ls组成一系列块Bs，则在Ls每行之前添加一个块引用标记则会组成一个块引用包含Bs

- 如果一系列行 Ls 构成了一个包含内容 Bs 的块引用，那么在其中一行或多行中，若块引用标记之后除空格或制表符外的下一个字符属于段落延续文本，删除这些行开头的块引用标记后，所得结果仍是一个包含内容 Bs 的块引用。

  - 块引用标记为`>`跟一个可选的空格
  - 段落延续文本指的是可以被解析为段落，但并不是段落的开头
  - 去掉块引用标记后解析为非段落的内容（可解析为其他结构）无法续上
  
- 一个文档无法连续包含两个块引用除非他们中间有空行

- 懒续行，当无法解析为任何结构时，作为未结束段落的懒续行

  ```
  > foo
      - bar
  // =====
  <blockquote>
  <p>foo
  - bar</p>
  </blockquote>
  
  由于以及超过了四个空格缩进，所以无法解析为list，同时因为缩进代码块无法终止段落，所以被续上了
  ```

- 引用块可以为空

- 引用块可以有初始或者结尾的空行（但不会被解析为空行，只会认作引用块的开始/或末尾

- 空行会分隔一个引用块为两个引用块

- 在一个引用块中包含两个段落的方法是插入一个引用空行

- 引用块会终止段落

- 一般情况下引用块前后无需空行，但由于懒续行的存在，引用块后面可以添加一个空行来切分后面的段落

- 由于懒续行，在引用块的连续行上可省略任意数量的引用标记

- 如果想在引用块中避免懒续行，则使用上面提到的空行

- 当要在引用块中使用缩进代码块时，需要五个空格做缩进，因为引用代码块本身可以包括一个空格的缩进。

### 列表项

- 列表标记包括无序列表标记和有序列表标记
- 无序列表标记包括`-+*`
- 有序列表标记为一个长度为1-9的阿拉伯数字（0-9）组成，后面跟着一个`.`字符或者`)`字符
- 如果一系列行Ls组成了一系列块Bs，且每行的开头都不是空格或者tab；M为一个长度为W的列表标记（包括列表标记前面的空格和后面的分隔符`.`or`)`），后面跟着N个空格（1<=N<=4），将M作用于Ls的第一行上，且后续的行前都加上W+N个长度的空格，则整体构成了一个列表项，列表项的类型取决于M的类型，且如果是有序列表，则M会作为起始数。
- 当需要将一个列表项的类似文本包含在段落中时，需要没有空行分隔，且如果是有序列表，则起始数字不能是1，因为起始数字为1的有序列表（非空行（非空列表项））形式会解析为有序列表，从而结束段落。

- 被动标题不能成为列表项

- 在容器块中定义列表标记起始位置时需要除去容器块部分

- 列表项可能会包含很多的空行，但不会解析

  ```
  - foo
  
  
    bar
  // ===
  <ul>
  <li>
  <p>foo</p>
  <p>bar</p>
  </li>
  </ul>
  ```

- 列表项可以包含任意块元素

- 列表项在包含缩进代码块的时候会保留代码块中的空行

  ```
  - Foo
  
        bar
  
  
        baz
  // ======
  <ul>
  <li>
  <p>Foo</p>
  <pre><code>bar
  
  
  baz
  </code></pre>
  </li>
  </ul>
  ```

- 有序列表的起始数字可以为0，若起始数字为"003"，则会解析为3，但起始数字不能为负数，负数按原文解析
- 如果列表项为缩进代码块开头，则会将列表标记后一个空格默认为列表标记自带的部分。
- 缩进代码块作为列表项时，额外的缩进会被包含在缩进代码块中
- 列表项中除了代码块外，不超过三个空格的缩进都会去掉
- 如果列表项首行为空行（不管有没有空格），则后面的行需缩进W+1个空格
- 列表项开头只可包含最多一个空行
- 只包含空行的列表项会被解析为空列表项
- 但空的列表项是无法结束段落的（会解析为段落内内容）
- 如果列表标记之前有1-3个空格缩进，则后续的行理所当然的要加上相同数量的空格缩进，也就是说标记之前的空格缩进也包括在W内
- 懒换行：类似于块引用的懒换行
- 子列表的列表标记在父列表项的缩进范围内
- 子列表可以在列表的第一个块
- 列表项可以包含主动标题/被动标题也可以（应该没有什么限制的块元素

### 列表

- 列表由多个相同类型的列表项组成，列表项之间可能会有一个或多个空行

- 相同类型指的是相同类型的列表标记，如果是有序列表，数字后的分隔符也需相同

- 松散列表

  - 如果存在列表项之间有空行分割
  - 某个列表项中包含两个或以上的块级元素且有空行作为分割
  - 代码块内的空行由于不是分隔块级元素的所以不算
  - 松散列表在解析时，其中的段落会包裹`<p>`标签

- 不同类型的列表标记会启用一个新的列表

- 列表可以结束段落，但空列表项不行

- 列表项之间可以存在任意个空行

- 如果想要切分开同样列表标记的列表项为两个列表，或者像在列表后跟缩进代码块，可以插入一个html注释块，注释不会展示，同时也满足结束列表的需求

  ```
  - foo
  - bar
  
  <!-- -->
  
  - baz
  - bim
  ```

- 只要一个列表项的缩进没有超过上一个列表项（而不是当前级别的第一个列表项，上一个列表项包括当前已有的每一个层级的最后一个列表项）的缩进，则认为他们是同一级的。

- 注意如果解析完成后超过了四个空格，则会被解析为缩进代码块，而缩进代码块无法结束段落，所以如果没有换行，则缩进代码块会被软换行到段落后。

- 松散与紧凑解析后的区别就是**每个列表项**会带个`<p>`：

  ```
  1. a
  2. b
  3. c
  >===
  <ol>
  <li>a</li>
  <li>b</li>
  <li>c</li>
  </ol>
  >==========<
  1. a
  
  2. b
  3. c
  >===
  <ol>
  <li>
  <p>a</p>
  </li>
  <li>
  <p>b</p>
  </li>
  <li>
  <p>c</p>
  </li>
  </ol>
  ```

- 父列表为松散/紧凑并不影响子列表是松散/紧凑，子列表的松散也不会导致父列表松散

# 内联类型/行内元素

 内联元素从左到右依次解析

## 代码段

- 反引号串由一个或多个未被转义的反引号组成
- 代码段由一个反引号串开头，由相同长度的反引号串结尾，中间夹着的就是代码段的内容。
- 内容中的行结尾会转换成空格
- 代码段不能包含空行
- 如果内容的结果字符串开头和结尾都有空格，但是内容不全是空格的话，允许删除首尾的一个空格，这将会允许出现代码段中的开头或者结尾有反引号，但要注意代码中的反引号与作为代码段结构的反引号长度必须有区别，这里只允许空格字符，并不允许其余的空白字符
- 如果内容全是空格，则不会进行删除首尾一个空格的操作
- 建议使用css`code{white-space: pre-wrap;}`避免空格被压缩
- 转义字符在代码段中不起作用，只会原文显示
- 只要首尾的反引号长度不会在内容中出现，则内容中可以出现任意长度的反引号串
- 在所有的行内元素中，除了HTML标签和自动链接外，代码段拥有最高的优先权。HTML标签和自动链接和代码段拥有相同的优先权，所以从左到右谁先开先解析谁
- 如果代码段没有找到能够匹配的结束反引号串，所有的反引号将以原文解析

## 斜体和粗体/强调和强烈强调

- 分隔符运行：一个机翻的名词，指一个序列，由一个或多个`*`组成，前面或者后面没有非反斜杠转义的`*`字符（没有其他`*`字符），或者由一个或多个`_`组成，前面或者后面没有非反斜杠转义的`_`字符（没有其他`_`字符）

- 左侧分隔符运行是指一个分隔符运行：
  - 后面不跟着Unicode空白字符
    - 后面不跟着Unicode标点符号
    - 或者后面跟着Unicode标点符号但同时前面有Unicode空白字符或者Unicode标点符号
  - 以上定义中，行首或者行尾都算作Unicode空白符号
  
- 右侧分隔符运行是指一个分隔符运行：
  - 前面没有Unicode空白字符
    - 前面没有Unicode标点符号
    - 或者前面有Unicode标点符号，同时后面有Unicode空白或者Unicode标点符号
  
- 以上定义中，行首或者行尾都算作Unicode空白符号
  
- 单个`*`可以开启强调iff它是左侧分隔符运行的一部分

- 单个`_`可以开启强调iff它是左侧分隔符运行的一部分，而且它要么不是右侧分隔符运行的一部分，要么是前面有Unicode标点符号的右侧分隔符运行的一部分 

- 单个`*`可以关闭强调iff它是右侧分隔符运行的一部分

- 单个`_`可以关闭强调iff它是右侧分隔符运行的一部分，而且它要么不是左侧分隔符运行的一部分，要么是后面有Unicode标点符号的左侧分隔符运行的一部分 

- 一个`**`可以开启强烈强调iff他是左侧分隔符的一部分

- 一个`__`可以开启强烈强调iff它是左侧分隔符运行的一部分，而且它要么不是右侧分隔符运行的一部分，要么是前面有Unicode标点符号的右侧分隔符运行的一部分 

- 一个`**`可以关闭强烈强调iff他是右侧分隔符的一部分

- 一个`__`可以关闭强烈强调iff它是右侧分隔符运行的一部分，而且它要么不是左侧分隔符运行的一部分，要么是后面有Unicode标点符号的左侧分隔符运行的一部分 

- 强调由一个可以开启强调的分隔符开启，由一个可以关闭强调的分隔符关闭。并且必须使用相同的符号`*_`，而且开启和关闭分隔符必须属于单独的分隔符运行。

  - 如果一个分隔符可以同时开启或者关闭强调，则开启和关闭分隔符运行的长度之和不能是3的倍数，或者开启和关闭分隔符运行的长度之和是3的倍数且两个分隔符的长度都是3的倍数

- 强烈强调由一个可以开启强烈强调的分隔符开启，由一个可以关闭强烈强调的分隔符关闭。并且必须使用相同的符号`*_`，而且开启和关闭分隔符必须属于单独的分隔符运行。

  - 如果一个分隔符可以同时开启或者关闭强调，则开启和关闭分隔符运行的长度之和不能是3的倍数，或者开启和关闭分隔符运行的长度之和是3的倍数且两个分隔符的长度都是3的倍数

- 三的倍数例子：

  ```
  *foo**bar*
  >===
  <p><em>foo**bar</em></p>
  >=======
  ***foo** bar*
  >==
  <p><em><strong>foo</strong> bar</em></p>
  ```

  

- 一个`*`不能出现在`*`分隔符前后，除非它是被转义的

- 一个`_`不能出现在`_`分隔符前后，除非它是被转义的

- 不允许交叉，且从左到右第一个出现的优先级高： `*foo _bar* baz_` is parsed as `<em>foo _bar</em> baz_` rather than `*foo <em>bar* baz</em>`

- 取最短：`**foo **bar baz**` is parsed as `**foo <strong>bar baz</strong>` rather than `<strong>foo **bar baz</strong>`，这个例子中，中间的并不满足关闭标签

- 行内代码段，链接，图片，HTML标签优先级高于强调：`*[foo*](bar)` is parsed as `*<a href="bar">foo*</a>` rather than as `<em>[foo</em>](bar)`

- 任何非空的内联元素都可以是强调或者强烈强调的内容

- 允许强调或者强烈强调相互嵌套但不能交叉

- 不允许有无内容的强调或者强烈强调

- 如果有不匹配的分隔符，应将多余的分隔符放在范围外而不是内

  ```
  ***foo**
  >==
  <p>*<strong>foo</strong></p>
  ```

- 如果想直接将强调嵌套在强调内，可以使用不同的符号，强烈强调可直接同符号

  ```
  *_foo_*
  >==
  <p><em><em>foo</em></em></p>
  >====
  ****foo****
  
  <p><strong><strong>foo</strong></strong></p>
  ```

- ```
  ***foo***
  >==
  <p><em><strong>foo</strong></em></p>
  ```

### 强调和链接的解析策略

使用分隔符栈来解析，每个栈元素需要包含如下信息：

- 分隔符类型`[`, `![`, `*`, `_`
- 分隔符数量？
- 分隔符是否激活状态
- 分隔符是否为潜在的开启符号，或者潜在的关闭符号，或者都是

当碰到符号`]`的时候，调用`look for link or image`

当碰到输入结束时，调用强调语法处理流程，此时直到碰到栈底元素为`NULL`

#### look for link or image 

 从分隔符栈顶倒找`[`或者`![`

- 如果没找到，则返回纯文本的`]`
- 如果找到一个，但没激活，则从栈里移除那个没激活的分隔符，接着返回纯文本的`]`
- 如果找到一个并且是激活的，则查看是否为行内/引用/压缩/short cut的链接或者图像
  - 如果不是，则从栈中移除开始标签，并且返回纯文本的`]`
  - 如果是，则
    - 返回链接或者图像节点，添加到开启符号的文本节点后
    - 在当前行内元素中执行`process emphasis`，将`[`作为栈底（碰到`[`则结束）
    - 移除栈中的`[`
    - 如果当前行内元素是链接而不是图片，则将前面所有的`[`符号都设为非激活状态，防止后面解析到嵌套的链接

#### process emphasis

该流程需要一个参数`stack_bottom`，来确认可以抵达的元素，NULL代表可以到栈底，否则，在碰到stack_bottom中的元素之前停止查找。

将当前指针current_position指向stack_bottom上面的一个元素

为每种分隔符类型（`_*`）都设置一个openers_bottom，初始化为stack_bottom,根据关闭分隔符运行的长度（模3）和关闭分隔符是否同时为开启分隔符来索引，用于记录每种分隔符类型搜索开启分隔符的下限。

接着循环如下步骤直到没有潜在的关闭结构

- 将当前关闭结构指针指针向前移动（栈底向栈顶），直到找到第一个潜在的关闭结构（有可能当前符号就是）
- 回头向栈底移动（移动开启结构指针），注意要在stack_bottom和当前分隔符类型的openers_bottom之上，找到第一个匹配的（相同的分隔符以及数量）开启结构
  - 如果找到
    - 判断是强调还是强烈强调，如果开启结构和结束结构的长度都大于等于2，则为强烈强调，否则为强调（强调优先级低）
    - 在开启节点的文本节点后插入对应的强调节点
    - 移除开启结构和结束结构中间的所有分隔符
    - 从开启结构和结束结构中移除一个或者两个分隔符（根据当前判断为强调还是强烈强调），如果该结构变空，则从栈中移除，同时设置当前指针为下一个元素
  - 如果没有找到
    - 设置当前类型分隔符的openers_bottom到当前结束指针前一位，因为这次扫描已经说明当前结束指针之前没有当前类型的开启结构了，下次无需往这个位置之前扫描
    - 如果说当前指针所指的关闭结构并不同时是一个开启结构，则说明该结构无用，从栈中移除当前结构，
    - 设置当前指针为下一个元素

## 链接Links

- 一个链接包括链接标签，一个链接定义，和一个可选的链接标题
- 在行内链接中，链接定义和链接标题会在链接标签后给出
- 在引用链接中，链接定义和标题会在文档的任意位置给出
- 链接标签
  - 一个链接标签可由零或多个行内元素组成，被方括号包裹
  - 链接不可以包裹其他链接，如果多个合法的链接嵌套，则解析最内部的
  - 链接标题中可包含被转义的方括号或者匹配的方括号
  - 行内代码段、自动链接、HTML标签比链接标签有着更高的优先级
- 链接定义
  - 一个字符序列，包含在尖括号中，其中不能包含行结尾或者未被转义的尖括号
  - 或者一个非空字符序列，不包含ASCII控制符号或者空格，可以包含被转义的或者匹配的圆括号
- 链接标题
  - 标题由双引号包裹，可以包含被转义的双引号
  - 或者由单引号包裹，可以包含被转义的单引号
  - 或者被圆括号包裹，可以包含被转义的圆括号

- 只有链接标签可以包含多行，但不能包含空行
- 行内链接包含一个链接标签，后面紧随一个左圆括号（中间不能有分隔），一个可选的链接定义和一个可选的链接标题，接着跟随一个右圆括号，这四部分中间可以以空格或者行结束分隔，链接定义和链接标题若都存在，则他们中间必须右空格或者tab或者最多一个行结束，其余的空白字符不被允许。

- ```
  [link](/uri "title")
  >===
  <p><a href="/uri" title="title">link</a></p>
  ```

- 以上三部分都可以各自为空

  ```
  []()
  >==
  <p><a href=""></a></p>
  ```

- 链接定义只有被包裹时可以包含空格，但其中无论如何不能包含行结束

  ```
  [link](/my uri)
  >==
  <p>[link](/my uri)</p>
  >====
  [link](</my uri>)
  >==
  <p><a href="/my%20uri">link</a></p>
  ```

- 注意，在不能别斜杠转义的字符之前添加的斜杠只是单纯的斜杠字符

- URL转义在链接定义中是被允许的

- 如果省略链接定义而保留title，则title会被转为链接定义

- 在链接标题中，不同的符号互相包裹是可以的

  ```
  [link](/url 'title "and" title')
  >===
  <p><a href="/url" title="title &quot;and&quot; title">link</a></p>
  ```

- 链接优先于强调
- HTML标签，代码段，自动链接优先于链接

### 引用链接

- full：由链接标签后立即跟链接标签左侧的方括号，该标签匹配文档中其他位置的链接引用定义；链接标签由方括号包裹（碰到的第一个右方括号结束），中间必须有至少一个非空字符，为转移的方括号不允许在该范围内，一个链接标签最多包含999个字符。匹配：去掉首位方括号，去掉首位的空格，tab，行结束，将多个连续空格或者tab或者行结束转为一个空格，忽略Unicode大小写，如果有多个匹配，则取第一个。

  ```
  [foo][bar]
  
  [bar]: /url "title"
  >===
  <p><a href="/url" title="title">foo</a></p>
  >========匹配的不是解析后的内容
  [bar][foo\!]
  
  [foo!]: /url
  >===
  <p>[bar][foo!]</p>
  ```

  链接标签的规则与行内链接中链接标签的规则相同，包括：可包含转义的或者匹配的方括号，可包含行内元素，其中不可包含其余链接

  链接标签不可包含未转义的方括号

- collapsed：链接标签即是链接引用定义标签，链接标签内容可省略

  ```
  [foo][]
  
  [foo]: /url "title"
  >===
  <p><a href="/url" title="title">foo</a></p>
  ```

- shortcut：在collapsed的基础上省略链接标签的方括号，其后如果要跟其他元素应该有空格

  ```
  [foo]
  
  [foo]: /url "title"
  >===  
  <p><a href="/url" title="title">foo</a></p>
  ```

- 行内link、full和collapsed优先于shortcut

- ```
  // 这里的barbaz解析为了引用链接
  [foo][bar][baz]
  
  [baz]: /url
  >===
  <p>[foo]<a href="/url">bar</a></p>
  >=======
  // 但是这个由于bar被定义，所以foobar解析为引用链接
  [foo][bar][baz]
  
  [baz]: /url1
  [bar]: /url2
  ```

## 图片

- 图片类似于链接，不同点在于图片之前要加一个`!`，组合成`![`

- 图片的link text为图片描述，且其中可以包含链接或者图片

  ```
  ![foo](/url "title")
  >==
  <p><img src="/url" alt="foo" title="title" /></p>
  >===========
  ![foo *bar*]
  
  [foo *bar*]: train.jpg "train & tracks"
  >==
  <p><img src="train.jpg" alt="foo bar" title="train &amp; tracks" /></p>
  >==========
  ![foo ![bar](/url)](/url2)
  >==
  <p><img src="/url2" alt="foo bar" /></p>
  >==========
  ![foo [bar](/url)](/url2)
  >==
  <p><img src="/url2" alt="foo bar" /></p>
  ```

- 可以看到在如上代码中，图片描述包裹的链接最后只渲染出了链接标签，这是因为图片描述中的内容在渲染为HTML时，只会取纯文本内容，丢弃标签等其他元素，比如强调包裹的文本也是如此。

## 自动链接

- 自动链接是被尖括号包裹的绝对路径URI地址或者邮箱地址，他们会被转为链接

- 尖括号中不能为空

- 绝对路径URI由协议，后面跟着冒号，再跟零到多个字符（非ASCII控制字符或者空格、尖括号）如果URI包括这些字符，必须使用百分号转义（URL编码）

- 协议应该是由2-32个字符组成，由ASCII字母开头，后面跟任意的ASCII字母、数字或者符号如`+.-`

- ```
  <http://foo.bar.baz>
  >===
  <p><a href="http://foo.bar.baz">http://foo.bar.baz</a></p>
  ```

- 即使是不真实的协议也可以

  ```
  <a+b+c:d>
  >===
  <p><a href="a+b+c:d">a+b+c:d</a></p>
  ```

- 斜杠转义在自动链接中不起作用

- 邮箱正则：

  ```
  /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?
  (?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/
  ```

- 邮箱：

  ```
  <foo@bar.example.com>
  >===
  <p><a href="mailto:foo@bar.example.com">foo@bar.example.com</a></p>
  ```

  

## RAW HTML

被尖括号包裹并且看着像HTML标签的文本，会被解析为原生HTML 标签

- 一个标签名由ASCII字母开头，后面跟0-n个字母数字或者中划线
- 一个属性包括空格tab或者最多一个行结束，一个属性名和一个可选的属性值定义
- 一个属性名由ASCII字母、下划线或者`:`开头，后面跟着0-n个ASCII字母、数字、下划线、`.:-`

- 属性值定义由可选的空格tab或者最多一个行结束，一个等于号，可选的空格tab或者最多一个行结束，和属性值组成
- 属性值可以被单引号或者双引号包裹，也可以没有包裹
- 没有包裹的属性值不可以包含空格、tab、行结束、`"'=<>`，以及反引号
- 单引号包裹的属性值不能包括单引号，双引号包裹的属性值不能包括双引号

- 启动标签由左尖括号开头，跟tag name，0-n个属性，可选的空格，tab或者最多一个行结束，一个可选的斜杠，以及右尖括号
- 结束标签由`</`开头，后跟标签名，可选的空格，tab或者最多一个行结束，一个右尖括号。
- HTML注释： `<!-->`, `<!--->`, or `<!--`, a string of characters not including the string `-->`, and `-->` 

- PI：由`<?`开头，中间包裹内容，`?>`结尾
- 声明由`<!`开头，an ASCII letter, zero or more characters not including the character ，`>`结尾
- CDATA由`<![CDATA[`开头，`]]>`结尾
- HTML标签有开始标签、结束标签、HTML注释、PI、声明和CDATA
- 转义斜杠在HTML属性中不起作用
- 实体引用或者数字字符会被保留在HTML属性中

## 硬换行

- 不在块结束的末尾的两个以上的空格再加一个行结束会组成硬换行
- 硬换行会被渲染为`<br/>`
- 转移斜杠可以代替硬换行中的行尾空格
- 硬换行的下一行开头的空格会被忽略
- 硬换行会出现在emphasis, links, and other constructs that allow inline content
- 硬换行不会出现在代码段中或者HTML标签中
- 硬换行被用于切开块中的行内内容，块结束不会有

## 软换行

- 没有在两个空格后的行结束会被解析为软换行
- 软换行解析为HTML会转为空格或者行结束，在浏览器中的表现形式都是一样的
- 渲染器可以提供选项将软换行渲染为硬换行

## 文本内容

没有被其他规则匹配的内容会被解析为纯文本，纯文本中的空格直接渲染到HTML中

```
Multiple     spaces
>===
<p>Multiple     spaces</p>
```

