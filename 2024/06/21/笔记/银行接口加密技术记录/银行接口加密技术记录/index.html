<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>银行接口加密技术记录 | Boranget.博客</title><meta name="author" content="Boranget"><meta name="copyright" content="Boranget"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="记录最近做了一些对接银行的接口，用到了各种加密技术，这里记录一下 PGPPGP工作原理简述 | Mr.Muzi (marcuseddie.github.io) gpg 密钥生成、导入、导出、自动输入密码_centos如何导入gpg-CSDN博客 OpenPGP 工作方式 | SAP Help Portal 汇丰银行要求使用PGP的方式来进行加解密，PGP最初是一款软件，其提供了一种混合加密的方式，">
<meta property="og:type" content="article">
<meta property="og:title" content="银行接口加密技术记录">
<meta property="og:url" content="https://boranget.github.io/2024/06/21/%E7%AC%94%E8%AE%B0/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="Boranget.博客">
<meta property="og:description" content="记录最近做了一些对接银行的接口，用到了各种加密技术，这里记录一下 PGPPGP工作原理简述 | Mr.Muzi (marcuseddie.github.io) gpg 密钥生成、导入、导出、自动输入密码_centos如何导入gpg-CSDN博客 OpenPGP 工作方式 | SAP Help Portal 汇丰银行要求使用PGP的方式来进行加解密，PGP最初是一款软件，其提供了一种混合加密的方式，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://boranget.github.io/assets/img/tx.png">
<meta property="article:published_time" content="2024-06-21T02:35:19.000Z">
<meta property="article:modified_time" content="2024-06-21T02:35:19.000Z">
<meta property="article:author" content="Boranget">
<meta property="article:tag" content="加密">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://boranget.github.io/assets/img/tx.png"><link rel="shortcut icon" href="/assets/img/tx.png"><link rel="canonical" href="https://boranget.github.io/2024/06/21/%E7%AC%94%E8%AE%B0/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '银行接口加密技术记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-21 10:35:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/img/tx.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">198</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="Boranget.博客"><img class="site-icon" src="/assets/img/tx.png"/><span class="site-name">Boranget.博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">银行接口加密技术记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-21T02:35:19.000Z" title="发表于 2024-06-21 10:35:19">2024-06-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-21T02:35:19.000Z" title="更新于 2024-06-21 10:35:19">2024-06-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="银行接口加密技术记录"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h1><p>最近做了一些对接银行的接口，用到了各种加密技术，这里记录一下</p>
<h1 id="PGP"><a href="#PGP" class="headerlink" title="PGP"></a>PGP</h1><p><a target="_blank" rel="noopener" href="https://marcuseddie.github.io/2019/PGP-Introduction.html">PGP工作原理简述 | Mr.Muzi (marcuseddie.github.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nyist_zxp/article/details/107597626">gpg 密钥生成、导入、导出、自动输入密码_centos如何导入gpg-CSDN博客</a></p>
<p><a target="_blank" rel="noopener" href="https://help.sap.com/docs/cloud-integration/sap-cloud-integration/how-openpgp-works">OpenPGP 工作方式 | SAP Help Portal</a></p>
<p>汇丰银行要求使用PGP的方式来进行加解密，PGP最初是一款软件，其提供了一种混合加密的方式，将需要传输的信息使用对称加密如AES算法加密，接着将对称加密的密钥使用非对称算法进行加密，同时会使用散列算法将报文进行摘要，并使用私钥对其进行签名。所有的信息都会被封装进一个数据结构，发送给对方。</p>
<p>后来PGP将其协议公开，形成了OpenPGP，而GPG是实现了该协议的一种工具，可用于加解密内容或者生成PGP密钥。</p>
<h2 id="PGP签名"><a href="#PGP签名" class="headerlink" title="PGP签名"></a>PGP签名</h2><ol>
<li><p>发送方使用摘要算法计算消息内容中的摘要（或哈希值）。</p>
<p> PGP 签名支持以下哈希算法：</p>
<ul>
<li>对于 DSA 密钥：SHA-1、SHA224、SHA256、SHA384、SHA512</li>
<li>对于 RSA 密钥：MD5、SHA-1、RIPE-MD&#x2F;160、SH256、SHA384、SHA512、SHA224</li>
</ul>
</li>
<li><p>发送方在发送方的 PGP 密钥环中查找私钥，使用私钥（类型 RSA 或 DSA）对摘要进行加密。</p>
</li>
<li><p>加密的哈希值以及使用的哈希算法一起写入签名元素，该签名元素将与有效负载一起（作为 PGP 签名格式）发送到接收方。私钥签名人的密钥标识（key id）也写入 PGP 签名元素。</p>
</li>
<li><p>接收方获取 PGP 签名格式。</p>
</li>
<li><p>接收方从签名中找到密钥标识（key id），并使用该密钥标识在接收方的 PGP 公钥环中查找正确的公钥。这是与用于签名有效负载的私钥相对应的公钥。</p>
<p> 另外，接收方检查用户标识（与密钥标识相关联）是否对应于允许的用户。</p>
</li>
<li><p>接收方使用公钥解密哈希值（并验证有效负载）。</p>
<p> <img src="/2024/06/21/%E7%AC%94%E8%AE%B0/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/PGP-Introduction-Digital-signature.png" alt="img"></p>
</li>
</ol>
<h2 id="PGP加解密"><a href="#PGP加解密" class="headerlink" title="PGP加解密"></a>PGP加解密</h2><p>在加密步骤之前，可以选择压缩数据。支持以下压缩算法：ZIP [RFC1951]、ZLIB [RFC1950]、BZip2</p>
<p>加密报文是使用对称密钥而不是非对称密钥，这是因为使用非对称算法加密内容，这需要耗费更多时间，故使用对称密钥加密报文后再使用非对称密钥加密前面使用的对称密钥，这样会节省更多资源。</p>
<ol>
<li><p>发送方生成一个对称密钥。</p>
</li>
<li><p>发送方使用该对称密钥加密有效负载。</p>
<p> 支持以下用于内容加密的对称密钥算法（对称密钥算法）：</p>
<p> TripleDES（168 位密钥，派生自 192 位）、CAST5（128 位密钥，如同 [RFC2144]）、Blowfish（128 位密钥，16 轮）、AES（128、192 和 256 位密钥）、Twofis（256 位密钥）</p>
<p> 不支持 DES。</p>
</li>
<li><p>发送方在 PGP 公钥环中查找 PGP 公钥。</p>
</li>
<li><p>发送方使用 PGP 公钥（来自 PGP 公钥环）加密对称密钥。</p>
<p> 您可以使用以下密钥类型加密对称密钥：RSA 和 Elgamal（不支持 DAS）。</p>
</li>
<li><p>发送方将加密后的对称密钥和密钥标识写入消息的加密信息元素。</p>
<p> 密钥标识用于标识用于加密的公钥（因为 PGP 公钥环可以包含多个公钥）。</p>
<p> 加密信息元素与加密的有效负载一起发送到接收方。</p>
</li>
<li><p>接收方获取消息，并根据在加密信息元素中的密钥标识在 PGP 密钥环中查找正确的私钥（与用于加密有效负载的公钥相关联）。</p>
<p> 访问私钥需要密码。</p>
</li>
<li><p>接收方使用来自 PGP 密钥环的私钥解密对称密钥。</p>
</li>
<li><p>接收方使用对称密钥解密有效负载。</p>
<p> <img src="/2024/06/21/%E7%AC%94%E8%AE%B0/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/%E9%93%B6%E8%A1%8C%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF%E8%AE%B0%E5%BD%95/PGP-Introduction-Encryption.png" alt="img"></p>
</li>
</ol>
<h2 id="GPG生成PGP密钥对"><a href="#GPG生成PGP密钥对" class="headerlink" title="GPG生成PGP密钥对"></a>GPG生成PGP密钥对</h2><ol>
<li><p>使用详细模式生成PGP密钥对</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg --full-gen-key</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看生成的公私钥</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gpg -K 或 --list-secret-keys : 查看私钥</span><br><span class="line">gpg -k 或 --list-public-keys : 查看公钥</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出公钥为ASCII文件</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gpg -a -o public-file.key --export keyId : 导出公钥keyId 到 文件 public-file.key中；</span><br><span class="line"></span><br><span class="line">其中：</span><br><span class="line"></span><br><span class="line">-a 为 --armor 的简写，表示密钥以ASCII的形式输出，默认以二进制的形式输出；</span><br><span class="line"></span><br><span class="line">-o 为 --output 的简写，指定写入的文件；</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出私钥为ASCII文件</p>
<p> 导出私钥时需要输入私钥密码</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpg -a -o private-file.key --export-secret-keys keyId</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="使用GPG工具加解密"><a href="#使用GPG工具加解密" class="headerlink" title="使用GPG工具加解密"></a>使用GPG工具加解密</h2><p>加密</p>
<p><code>gpg --recipient [用户ID] --output test.en.txt --encrypt test.txt </code></p>
<p>解密</p>
<p><code> gpg --output test.de.txt --decrypt test.en.txt</code></p>
<h2 id="使用java进行PGP内容的加解密和签验签"><a href="#使用java进行PGP内容的加解密和签验签" class="headerlink" title="使用java进行PGP内容的加解密和签验签"></a>使用java进行PGP内容的加解密和签验签</h2><p>用到的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bouncycastle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>bcpg-jdk15on<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.68<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>PGPHelper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lshcpi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.bcpg.*;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.jce.provider.BouncyCastleProvider;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.*;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.operator.PBESecretKeyDecryptor;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.operator.PublicKeyDataDecryptorFactory;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.operator.jcajce.*;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.util.io.Streams;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This class is used to encrypt and decrypt data using PGP keys.</span></span><br><span class="line"><span class="comment"> * Encrypted data can be used to call the HSBC Treasury APIs.</span></span><br><span class="line"><span class="comment"> * The response from the HSBC Treasury APIs can be decrypted using the same keys.</span></span><br><span class="line"><span class="comment"> * Keys and the headers used to call the HSBC Treasury APIs are provided by HSBC on the Developer Portal for each project.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * Created by 44024985 on 04/09/2018.</span></span><br><span class="line"><span class="comment"> * Updated by 45274934 on 28/03/2024.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PgpHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> JcaKeyFingerprintCalculator keyFingerPrintCalculator;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Provider bcp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PgpHelper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.keyFingerPrintCalculator = <span class="keyword">new</span> <span class="title class_">JcaKeyFingerprintCalculator</span>();</span><br><span class="line">        <span class="built_in">this</span>.bcp = <span class="keyword">new</span> <span class="title class_">BouncyCastleProvider</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method reads a public key from an input stream and returns a list of PGP Public Keys.</span></span><br><span class="line"><span class="comment">     * The list of PGP Public Key objects are used as an input for &#123;<span class="doctag">@link</span> #encryptAndSign(OutputStream, InputStream, PGPPublicKey, PGPPrivateKey)&#125; and &#123;<span class="doctag">@link</span> #decryptStream(InputStream, OutputStream, List, List)&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> publicKeyInputStream bank/public key input stream.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List of PGP Public Keys</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;PGPPublicKey&gt; <span class="title function_">readPublicKey</span><span class="params">(InputStream publicKeyInputStream)</span> <span class="keyword">throws</span> IOException, PGPException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// public key file is decoded and used to generate a key ring object that stores a list of key rings. These contain the public keys.</span></span><br><span class="line">        <span class="comment">// The fingerPrintCalculator is used to calculate the fingerprint of each key which is needed to verify key authenticity.</span></span><br><span class="line">        <span class="type">PGPPublicKeyRingCollection</span> <span class="variable">pgpPub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPPublicKeyRingCollection</span>(PGPUtil.getDecoderStream(publicKeyInputStream),</span><br><span class="line">                <span class="built_in">this</span>.keyFingerPrintCalculator);</span><br><span class="line"></span><br><span class="line">        List&lt;PGPPublicKey&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        pgpPub.getKeyRings().forEachRemaining(keyRing -&gt; keyRing.getPublicKeys().forEachRemaining(keys::add));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (keys.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can&#x27;t find encryption key in key ring.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> keys;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method finds a PGP Private key from a PGP secret key ring using a passphrase.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pgpSecKey Secret Key.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pass      passphrase to decrypt secret key with.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> PGPPrivate key.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> PGPPrivateKey <span class="title function_">findSecretKey</span><span class="params">(PGPSecretKey pgpSecKey, <span class="type">char</span>[] pass)</span></span><br><span class="line">            <span class="keyword">throws</span> PGPException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Extract a private key from a PGPSecretKey object.</span></span><br><span class="line">        <span class="type">PBESecretKeyDecryptor</span> <span class="variable">decryptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JcePBESecretKeyDecryptorBuilder</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">JcaPGPDigestCalculatorProviderBuilder</span>().setProvider(<span class="built_in">this</span>.bcp).build()).setProvider(<span class="built_in">this</span>.bcp).build(pass);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pgpSecKey.extractPrivateKey(decryptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method reads a secret key from an input stream and returns a list of PGP Secret Keys.</span></span><br><span class="line"><span class="comment">     * These then need to be extracted to get the private key using the passphrase. This step is carried out by &#123;<span class="doctag">@link</span> #findSecretKey(PGPSecretKey, char[]) findSecretKey&#125;.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input private key input stream.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> List of PGP Secret Keys</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;PGPSecretKey&gt; <span class="title function_">readSecretKey</span><span class="params">(InputStream input)</span> <span class="keyword">throws</span> IOException, PGPException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Secret key ring collection is generated from the private key file input stream.</span></span><br><span class="line">        <span class="type">PGPSecretKeyRingCollection</span> <span class="variable">pgpSec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPSecretKeyRingCollection</span>(</span><br><span class="line">                PGPUtil.getDecoderStream(input), <span class="built_in">this</span>.keyFingerPrintCalculator);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Loop through key rings, then through keys and add keys found to list.</span></span><br><span class="line">        List&lt;PGPSecretKey&gt; keys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        pgpSec.getKeyRings().forEachRemaining(keyRing -&gt; keyRing.getSecretKeys().forEachRemaining(keys::add));</span><br><span class="line">        <span class="keyword">if</span> (keys.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Can&#x27;t find signing key in key ring.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> keys;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method encrypts and signs a stream of data using a public key and a private key.</span></span><br><span class="line"><span class="comment">     * The output is a PGP message which as been base64-encoded and contains the signed, encrypted data.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outf        the output stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputStream the input stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encKey      the PGP Public key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> privateKey  the private key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">encryptAndSign</span><span class="params">(OutputStream outf, InputStream inputStream, PGPPublicKey encKey,</span></span><br><span class="line"><span class="params">                               PGPPrivateKey privateKey)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArmoredOutputStream</span>(outf);</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">lOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Encrypted Data Generator</span></span><br><span class="line">            <span class="type">PGPEncryptedDataGenerator</span> <span class="variable">encGen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPEncryptedDataGenerator</span>(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">JcePGPDataEncryptorBuilder</span>(SymmetricKeyAlgorithmTags.AES_256).setWithIntegrityPacket(<span class="literal">true</span>)</span><br><span class="line">                            .setSecureRandom(<span class="keyword">new</span> <span class="title class_">SecureRandom</span>()).setProvider(<span class="built_in">this</span>.bcp));</span><br><span class="line">            encGen.addMethod(<span class="keyword">new</span> <span class="title class_">JcePublicKeyKeyEncryptionMethodGenerator</span>(encKey).setProvider(<span class="built_in">this</span>.bcp));</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">encryptedOut</span> <span class="operator">=</span> encGen.open(out, <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Compressed Data Generator</span></span><br><span class="line">            <span class="type">PGPCompressedDataGenerator</span> <span class="variable">comData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPCompressedDataGenerator</span>(CompressionAlgorithmTags.ZIP);</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">compressedData</span> <span class="operator">=</span> comData.open(encryptedOut);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Signature Generator</span></span><br><span class="line">            <span class="type">PGPSignatureGenerator</span> <span class="variable">sGen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPSignatureGenerator</span>(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">JcaPGPContentSignerBuilder</span>(privateKey.getPublicKeyPacket().getAlgorithm(), HashAlgorithmTags.SHA512)</span><br><span class="line">                            .setProvider(<span class="built_in">this</span>.bcp));</span><br><span class="line">            sGen.init(PGPSignature.BINARY_DOCUMENT, privateKey);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the user ID from the encryption key, and use this to generate a signed subpacket.</span></span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">it</span> <span class="operator">=</span> encKey.getUserIDs();</span><br><span class="line">            <span class="keyword">if</span> (it.hasNext()) &#123;</span><br><span class="line">                <span class="type">PGPSignatureSubpacketGenerator</span> <span class="variable">spGen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPSignatureSubpacketGenerator</span>();</span><br><span class="line">                spGen.setSignerUserID(<span class="literal">false</span>, (String) it.next());</span><br><span class="line">                sGen.setHashedSubpackets(spGen.generate());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write the encoded packet to compressed data stream.</span></span><br><span class="line">            sGen.generateOnePassVersion(<span class="literal">false</span>).encode(compressedData); <span class="comment">// bOut</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Create a literal data output stream</span></span><br><span class="line">            <span class="type">PGPLiteralDataGenerator</span> <span class="variable">lGen</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPLiteralDataGenerator</span>();</span><br><span class="line">            lOut = lGen.open(compressedData, PGPLiteralData.BINARY, <span class="string">&quot;Sample-Data&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">byte</span>[inputStream.available()]);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Write and sign data.</span></span><br><span class="line">            <span class="type">byte</span>[] data = IOUtils.toByteArray(inputStream);</span><br><span class="line">            lOut.write(data);</span><br><span class="line">            sGen.update(data);</span><br><span class="line"></span><br><span class="line">            lGen.close();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Generate signature for compressed data.</span></span><br><span class="line">            sGen.generate().encode(compressedData);</span><br><span class="line"></span><br><span class="line">            comData.close();</span><br><span class="line">            compressedData.close();</span><br><span class="line"></span><br><span class="line">            encryptedOut.close();</span><br><span class="line">            encGen.close();</span><br><span class="line"></span><br><span class="line">            out.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PGPException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.getUnderlyingException() != <span class="literal">null</span>) &#123;</span><br><span class="line">                e.getUnderlyingException().printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (lOut != <span class="literal">null</span>) lOut.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * This method decrypts a stream of data (PGP message) using a list of private keys and a list of public keys.</span></span><br><span class="line"><span class="comment">     * The signature is verified using the public keys.</span></span><br><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in         the input stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out        the output stream</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keysIn     the list of private keys</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> publicKeys the list of public keys</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decryptStream</span><span class="params">(InputStream in, OutputStream out, List&lt;PGPPrivateKey&gt; keysIn,</span></span><br><span class="line"><span class="params">                              List&lt;PGPPublicKey&gt; publicKeys)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">PGPObjectFactory</span> <span class="variable">pgpF</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPObjectFactory</span>(PGPUtil.getDecoderStream(in), <span class="built_in">this</span>.keyFingerPrintCalculator);</span><br><span class="line">        PGPEncryptedDataList enc;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> pgpF.nextObject();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Parse first object, which might be a PGP marker packet.</span></span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> PGPEncryptedDataList) &#123;</span><br><span class="line">            enc = (PGPEncryptedDataList) o;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            enc = (PGPEncryptedDataList) pgpF.nextObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the secret key</span></span><br><span class="line">        Iterator&lt;PGPEncryptedData&gt; it = enc.getEncryptedDataObjects();</span><br><span class="line">        <span class="type">PGPPublicKeyEncryptedData</span> <span class="variable">pbe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="type">PGPEncryptedData</span> <span class="variable">encryptedData</span> <span class="operator">=</span> it.next();</span><br><span class="line">            <span class="keyword">if</span> (encryptedData <span class="keyword">instanceof</span> PGPPublicKeyEncryptedData) &#123;</span><br><span class="line">                pbe = (PGPPublicKeyEncryptedData) encryptedData;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        PublicKeyDataDecryptorFactory b;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">clear</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (PGPPrivateKey keyIn : keysIn) &#123;</span><br><span class="line">            <span class="keyword">if</span> (keyIn.getKeyID() == pbe.getKeyID()) &#123;</span><br><span class="line">                b = <span class="keyword">new</span> <span class="title class_">JcePublicKeyDataDecryptorFactoryBuilder</span>().setProvider(<span class="built_in">this</span>.bcp).setContentProvider(<span class="built_in">this</span>.bcp).build(keyIn);</span><br><span class="line">                clear = pbe.getDataStream(b);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == clear) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PGPKeyValidationException</span>(<span class="string">&quot;Invalid public key used for encryption&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PGPObjectFactory</span> <span class="variable">plainFact</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PGPObjectFactory</span>(clear, <span class="built_in">this</span>.keyFingerPrintCalculator);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">message</span> <span class="operator">=</span> plainFact.nextObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">PGPOnePassSignatureList</span> <span class="variable">onePassSignatureList</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">PGPSignatureList</span> <span class="variable">signatureList</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        PGPCompressedData compressedData;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">actualOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">while</span> (message != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (message <span class="keyword">instanceof</span> PGPCompressedData) &#123;</span><br><span class="line">                compressedData = (PGPCompressedData) message;</span><br><span class="line">                plainFact = <span class="keyword">new</span> <span class="title class_">PGPObjectFactory</span>(compressedData.getDataStream(), <span class="built_in">this</span>.keyFingerPrintCalculator);</span><br><span class="line">                message = plainFact.nextObject();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (message <span class="keyword">instanceof</span> PGPLiteralData) &#123;</span><br><span class="line">                <span class="comment">// have to read it and keep it somewhere.</span></span><br><span class="line">                Streams.pipeAll(((PGPLiteralData) message).getInputStream(), actualOutput);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> PGPOnePassSignatureList) &#123;</span><br><span class="line">                onePassSignatureList = (PGPOnePassSignatureList) message;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> PGPSignatureList) &#123;</span><br><span class="line">                signatureList = (PGPSignatureList) message;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PGPException</span>(<span class="string">&quot;message unknown message type.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            message = plainFact.nextObject();</span><br><span class="line">        &#125;</span><br><span class="line">        actualOutput.close();</span><br><span class="line">        <span class="type">byte</span>[] output = actualOutput.toByteArray();</span><br><span class="line">        <span class="keyword">if</span> (onePassSignatureList == <span class="literal">null</span> || signatureList == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PGPException</span>(<span class="string">&quot;Poor PGP. Signatures not found.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">signatureVerified</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; onePassSignatureList.size(); i++) &#123;</span><br><span class="line">                <span class="type">PGPOnePassSignature</span> <span class="variable">ops</span> <span class="operator">=</span> onePassSignatureList.get(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (publicKeys != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (PGPPublicKey publicKey : publicKeys) &#123;</span><br><span class="line">                        ops.init(<span class="keyword">new</span> <span class="title class_">JcaPGPContentVerifierBuilderProvider</span>().setProvider(<span class="built_in">this</span>.bcp), publicKey);</span><br><span class="line">                        ops.update(output);</span><br><span class="line">                        <span class="type">PGPSignature</span> <span class="variable">signature</span> <span class="operator">=</span> signatureList.get(i);</span><br><span class="line">                        <span class="keyword">if</span> (ops.verify(signature)) &#123;</span><br><span class="line">                            signatureVerified = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!signatureVerified) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SignatureException</span>(<span class="string">&quot;Signature verification failed&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pbe.isIntegrityProtected() &amp;&amp; !pbe.verify()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">PGPDataValidationException</span>(<span class="string">&quot;Data is integrity protected but integrity is lost.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (publicKeys == <span class="literal">null</span> || publicKeys.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SignatureException</span>(<span class="string">&quot;Signature not found&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            out.write(output);</span><br><span class="line">            out.flush();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PGPUtils</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lshcpi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.PGPException;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.PGPPrivateKey;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.PGPPublicKey;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.openpgp.PGPSecretKey;</span><br><span class="line"><span class="keyword">import</span> org.bouncycastle.util.encoders.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PGPUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">enc</span><span class="params">(String ori, String clientPrivateKeyBass64, String bankPublicKeyBass64, String privateKeyPassword)</span> <span class="keyword">throws</span> IOException, PGPException &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declare PGP helper instance.</span></span><br><span class="line">        <span class="type">PgpHelper</span> <span class="variable">pgpHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PgpHelper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declare output string.</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedRes</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加密结果输出流</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="comment">// 原文输入流</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>( <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(ori.getBytes(StandardCharsets.UTF_8)));</span><br><span class="line">        <span class="comment">// 客户端私钥输入流</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">clientPrivateKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.decode(clientPrivateKeyBass64)));</span><br><span class="line">        <span class="comment">// 银行公钥输入流</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">bankPublicKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.decode(bankPublicKeyBass64)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Create PGPSecretKey object.</span></span><br><span class="line">            List&lt;PGPSecretKey&gt; key = pgpHelper.readSecretKey(clientPrivateKey);</span><br><span class="line">            <span class="comment">// Get PrivateKey Objects from SecretKey using passphrase.</span></span><br><span class="line">            List&lt;PGPPrivateKey&gt; clientPrivateKeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// passphrase</span></span><br><span class="line">            <span class="keyword">for</span> (PGPSecretKey pgpSecretKey : key) &#123;</span><br><span class="line">                clientPrivateKeys.add(pgpHelper.findSecretKey(pgpSecretKey, privateKeyPassword.toCharArray()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get PGPPublicKey.</span></span><br><span class="line">            List&lt;PGPPublicKey&gt; pgpPublicKeys = pgpHelper.readPublicKey(bankPublicKey);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// BEGIN ENCRYPTION //</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Taking the outputStream, inputStream data and keys to encrypt the data.</span></span><br><span class="line">            pgpHelper.encryptAndSign(outputStream, inputStream, pgpPublicKeys.get(<span class="number">0</span>), clientPrivateKeys.get(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Encode in Base64 for sending to the treasury API.</span></span><br><span class="line">            encodedRes = Base64.toBase64String(outputStream.toByteArray());</span><br><span class="line">            <span class="keyword">return</span> encodedRes;</span><br><span class="line">            <span class="comment">// END ENCRYPTION //</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** Exception ****&quot;</span>);</span><br><span class="line">            System.out.println(ex.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) outputStream.close();</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) inputStream.close();</span><br><span class="line">            <span class="keyword">if</span> (clientPrivateKey != <span class="literal">null</span>) clientPrivateKey.close();</span><br><span class="line">            <span class="keyword">if</span> (bankPublicKey != <span class="literal">null</span>) bankPublicKey.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">dec</span><span class="params">(String encStr, String clientPrivateKeyBass64, String bankPublicKeyBass64, String privateKeyPassword)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 客户端私钥输入流</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">clientPrivateKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.decode(clientPrivateKeyBass64)));</span><br><span class="line">        <span class="comment">// 银行公钥输入流</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">bankPublicKey</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.decode(bankPublicKeyBass64)));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Declare PGP helper instance.</span></span><br><span class="line">        <span class="type">PgpHelper</span> <span class="variable">pgpHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PgpHelper</span>();</span><br><span class="line">        <span class="comment">// Declare input stream.</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">dataStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">decryptedResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in public key, private key and input data (to be encrypted) file.</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// Create PGPSecretKey object.</span></span><br><span class="line">            List&lt;PGPSecretKey&gt; key = pgpHelper.readSecretKey(clientPrivateKey);</span><br><span class="line">            <span class="comment">// Get PrivateKey Objects from SecretKey using passphrase.</span></span><br><span class="line">            List&lt;PGPPrivateKey&gt; clientPrivateKeys = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="comment">// passphrase</span></span><br><span class="line">            <span class="keyword">for</span> (PGPSecretKey pgpSecretKey : key) &#123;</span><br><span class="line">                clientPrivateKeys.add(pgpHelper.findSecretKey(pgpSecretKey, privateKeyPassword.toCharArray()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Get PGPPublicKey.</span></span><br><span class="line">            List&lt;PGPPublicKey&gt; pgpPublicKeys = pgpHelper.readPublicKey(bankPublicKey);</span><br><span class="line">            <span class="comment">// BEGIN DECRYPTION //</span></span><br><span class="line">            <span class="comment">// Decode the encrypted Payload</span></span><br><span class="line">            <span class="type">byte</span>[] decodedPayload = Base64.decode(encStr.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">            <span class="comment">// Convert decoded data to InputStream.</span></span><br><span class="line">            dataStream = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decodedPayload));</span><br><span class="line">            <span class="comment">// Decrypt the data.</span></span><br><span class="line">            pgpHelper.decryptStream(dataStream, decryptedResult, clientPrivateKeys, pgpPublicKeys);</span><br><span class="line">            <span class="comment">// Convert decrypted data to String.</span></span><br><span class="line">            res = decryptedResult.toString(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            <span class="comment">// END DECRYPTION //</span></span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;**** Exception ****&quot;</span>);</span><br><span class="line">            System.out.println(ex.getMessage());</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dataStream != <span class="literal">null</span>) dataStream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ori</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;transactionDate\&quot;: \&quot;2024-06-18\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;accountNumber\&quot;: \&quot;622001234015\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;accountCountry\&quot;: \&quot;CN\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;  \&quot;accountType\&quot;: \&quot;CA\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">// 私钥文件编码结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">clientPrivateKeyBass64</span> <span class="operator">=</span> <span class="string">&quot;LS0ZONmpSY3ZIdkFtCktaWEtzc3FKamg2czhxblpvWEsxUitUVklLSXYyRTB6Q2JiNVFENVpveVlPeEg2Ykg1QXpnU0tVQTdsT29sQ1UKWTYwblpuWlB4ZmdWckRBY3RBNHpJdmxYY21vOHhDdFdQVzdPSWJLSWZOb3JEZmphNTh0NnZzTWh1WUFGWFQvUwpNTWZtbW90dmxnPT0KPXhzVmEKLS0tLS1FTkQgUEdQIFBSSVZBVEUgS0VZIEJMT0NLLS0tLS0K&quot;</span>;</span><br><span class="line">        <span class="comment">// 银行公钥文件编码结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bankPublicKeyBass64</span> <span class="operator">=</span> <span class="string">&quot;LS0tL29XSzAwbmNOWk1VNmwrSDF1Y09jV3JXWEVWQ2xnajl6d2NsNQpVRHNMQS9ocjBXRHZTVHZQM0w3QWQ2RUltalBob290bnB1bGUwd000YlpyRVBkTnpUVmxKWWRwRlhVcz0KPS9hdDYKLS0tLS1FTkQgUEdQIFBVQkxJQyBLRVkgQkxPQ0stLS0tLQo=&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedRes</span> <span class="operator">=</span> enc(ori,clientPrivateKeyBass64,bankPublicKeyBass64,<span class="string">&quot;123-123eq0&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Base64-encoded PGP message containing encrypted payload:\n&quot;</span> + encodedRes);</span><br><span class="line">        <span class="comment">// 加密内容编码结果</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encStr</span> <span class="operator">=</span> <span class="string">&quot;LS0tTkhHK3BQVEYwcE1pUXJwRVdSRnZZdGpzUlhSZTR3YUhvc2dReXVrUnZnaUE9PQo9UWN0MwotLS0tLUVORCBQR1AgTUVTU0FHRS0tLS0tCg==&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> dec(encStr, clientPrivateKeyBass64, bankPublicKeyBass64, <span class="string">&quot;123-123eq0&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Decrypted message:\n&quot;</span> + res);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="相关名词"><a href="#相关名词" class="headerlink" title="相关名词"></a>相关名词</h1><ul>
<li>X.509 一种通用的证书格式，包含证书持有人的公钥，加密算法等信息，X.509文件一般以crt结尾，其内容有pem和der两种</li>
<li>pkcs1~pkcs12 公钥加密(非对称中)的一种标准，*.p12是包含证书和密钥的封装格式</li>
<li>*.der 证书的二进制存储格式，java和win偏向于使用</li>
<li>*.pem 证书或密钥的Base64文本存储格式，可以单独存放证书和密钥，也可以同时存放证书或者密钥</li>
<li>*.key 单独存放pem格式的密钥</li>
<li>*.cer, *.crt 证书，certificate，linux下叫crt，win下叫cer，存储格式可以为der或者pem两种</li>
<li>*.key 私钥</li>
<li>*.csr 证书签名请求，一般其中存放公钥，将其提交给证书颁发机构生成证书</li>
<li>*.jks java的证书格式，里面存放key和信任的CA，可以存放多个</li>
<li>pfx 微软IIS的实现</li>
<li>openssl 相当于ssl的一个实现</li>
</ul>
<h1 id="keytool生成rsa密钥对并存储到jks中"><a href="#keytool生成rsa密钥对并存储到jks中" class="headerlink" title="keytool生成rsa密钥对并存储到jks中"></a>keytool生成rsa密钥对并存储到jks中</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -keysize 2048 -keyalg RSA -alias apisigkey -keystore scbapibanking.jks</span><br></pre></td></tr></table></figure>

<p>这条命令是使用Java的<code>keytool</code>工具来生成一个新的密钥对（key pair），并将其存储在名为<code>scbapibanking.jks</code>的密钥库中（keystore）。下面是对命令中各个部分的解释：</p>
<ul>
<li><code>keytool</code>：这是Java开发工具包（JDK）自带的一个密钥和证书管理工具，用于管理密钥库（keystore）中的密钥和证书。</li>
<li><code>-genkeypair</code>：这个选项告诉<code>keytool</code>要生成一个新的密钥对。密钥对包括一个公钥和一个私钥，公钥可以公开分享，而私钥应该保密。</li>
<li><code>-keysize 2048</code>：这个选项指定生成的RSA密钥对的密钥长度为2048位。密钥长度越长，安全性越高，但计算成本也越高。2048位是一个常用的安全长度，既保证了安全性，又保持了较好的性能。</li>
<li><code>-keyalg RSA</code>：这个选项指定使用的密钥算法是RSA。RSA是一种广泛使用的非对称加密算法，它使用一对密钥（公钥和私钥）进行加密和解密操作。</li>
<li><code>-alias apisigkey</code>：这个选项为生成的密钥对指定了一个别名（alias），这里的别名是<code>apisigkey</code>。别名用于在密钥库中唯一标识密钥对或证书。</li>
<li><code>-keystore scbapibanking.jks</code>：这个选项指定了密钥库的名称和位置，这里的密钥库名为<code>scbapibanking.jks</code>。如果密钥库文件不存在，<code>keytool</code>会创建它。密钥库是存储密钥对和证书的安全容器，可以通过密码保护来防止未授权访问。</li>
</ul>
<p>需要注意的是，运行这条命令时，<code>keytool</code>会提示你输入密钥库的密码（如果密钥库不存在）和密钥对的密码（可以选择与密钥库密码相同或不同）。这些密码用于保护密钥库和密钥对的安全。</p>
<p>总结来说，这条命令生成了一个使用RSA算法、密钥长度为2048位的密钥对，并将其存储在名为<code>scbapibanking.jks</code>的密钥库中，通过<code>apisigkey</code>这个别名来引用这个密钥对。</p>
<h2 id="显示jks中存储的密钥"><a href="#显示jks中存储的密钥" class="headerlink" title="显示jks中存储的密钥"></a>显示jks中存储的密钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -keystore scbapibanking.jks -storepass 123456</span><br></pre></td></tr></table></figure>

<h2 id="从jks中导出证书"><a href="#从jks中导出证书" class="headerlink" title="从jks中导出证书"></a>从jks中导出证书</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -exportcert -keystore scbapibanking.jks -alias apisigkey -rfc -file certificate.pem</span><br></pre></td></tr></table></figure>

<h2 id="从证书中导出公钥"><a href="#从证书中导出公钥" class="headerlink" title="从证书中导出公钥"></a>从证书中导出公钥</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -pubkey -noout -in certificate.pem &gt; clientpubkey.pem</span><br></pre></td></tr></table></figure>

<p><code>openssl x509 -pubkey -noout -in certificate.pem &gt; clientpubkey.pem</code> 这条命令使用了 OpenSSL 工具来从给定的证书文件（<code>certificate.pem</code>）中提取公钥，并将这个公钥输出到另一个文件（<code>clientpubkey.pem</code>）中。下面是对这条命令各个部分的详细解释：</p>
<ul>
<li><code>openssl</code>: 这是 OpenSSL 工具的命令行调用，OpenSSL 是一个强大的安全套接字层（SSL）和传输层安全（TLS）协议，以及一个全面的加密库，它提供了丰富的加密功能。</li>
<li><code>x509</code>: 这是 OpenSSL 中的一个多功能命令，用于处理 X.509 证书。X.509 是一种定义公钥证书结构的标准，广泛用于 SSL&#x2F;TLS 加密中。</li>
<li><code>-pubkey</code>: 这个选项告诉 <code>x509</code> 命令只输出证书中的公钥部分。默认情况下，<code>x509</code> 命令会输出证书的完整内容，包括公钥、颁发者信息、持有者信息等。</li>
<li><code>-noout</code>: 这个选项告诉 <code>x509</code> 命令不要输出证书本身的编码信息，只输出请求的信息（在这个例子中，是公钥）。</li>
<li><code>-in certificate.pem</code>: 这个选项指定了输入文件的名称和路径，即要从中提取公钥的证书文件。在这个例子中，证书文件名为 <code>certificate.pem</code>。</li>
<li><code>&gt; clientpubkey.pem</code>: 这部分不是 OpenSSL 命令的一部分，而是 shell（如 bash、zsh 等）的重定向功能。它告诉 shell 将 <code>x509</code> 命令的输出（即公钥）重定向到 <code>clientpubkey.pem</code> 文件中，而不是显示在终端上。</li>
</ul>
<p>综上所述，这条命令的作用是：从 <code>certificate.pem</code> 文件中提取公钥，并将这个公钥保存到 <code>clientpubkey.pem</code> 文件中。这对于需要单独使用公钥的场景非常有用，比如验证签名、加密数据等。</p>
<h1 id="SSL双向认证"><a href="#SSL双向认证" class="headerlink" title="SSL双向认证"></a>SSL双向认证</h1><p>在ssl双向认证中，除了客户端要验证服务端的证书外，服务端也需要验证客户端的证书，也就是客户端会拥有一套证书和密钥，</p>
<p>一般情况下，服务端会将消息使用客户端证书中的公钥进行加密，发给客户端，客户端再使用与证书配套的私钥将报文进行解密，而在客户端向服务端发送信息时，则会先使用服务端公钥进行加密，服务端收到后，再使用服务端的私钥进行解密。</p>
<p>记一个双向认证的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zhada.helper2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.JsonElement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.client.methods.HttpPost;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.config.Registry;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.config.RegistryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.socket.ConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.socket.PlainConnectionSocketFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.NoopHostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.conn.ssl.SSLConnectionSocketFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClients;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.ssl.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.entity.StringEntity;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.CloseableHttpClient;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.client.HttpClientBuilder;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.impl.conn.PoolingHttpClientConnectionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.HostnameVerifier;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLContext;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyManagementException;</span><br><span class="line"><span class="keyword">import</span> java.security.PrivateKey;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.security.interfaces.RSAPrivateKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.gson.JsonObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.minidev.json.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.oauth.jsontoken.JsonToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.oauth.jsontoken.crypto.RsaSHA256Signer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.joda.time.Instant;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.lang.System.currentTimeMillis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActiveHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JTI_KEY</span> <span class="operator">=</span> <span class="string">&quot;jti&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUDIENCE</span> <span class="operator">=</span> <span class="string">&quot;SCB-APIBanking&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TOKEN_TIMEOUT_DURATION</span> <span class="operator">=</span> <span class="number">1000L</span> * <span class="number">30L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAYLOAD</span> <span class="operator">=</span> <span class="string">&quot;payload&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks文件路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">jksFilePath</span> <span class="operator">=</span> <span class="string">&quot;zhada/active/renewal-test-zhada.jks&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;123-123eq0&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 签名使用的密钥对别名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">jksAlise</span> <span class="operator">=</span> <span class="string">&quot;apisigkey&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 银行返回的两个参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">bankProvideKey</span> <span class="operator">=</span> <span class="string">&quot;OqwtftHhp6W7BKRb48R0S9WZuUqT/Q==&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">bankProvidedContent</span> <span class="operator">=</span> <span class="string">&quot;SVZTVUZGSVivDbdQh0la&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cpi暴露出的webhook地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">webhookUrl</span> <span class="operator">=</span> <span class="string">&quot;htt:....ebHook&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求渣打的功能地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="string">&quot;https://apite...t2/activate&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取jks</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">keyStoreData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(jksFilePath); <span class="comment">// Provide path for java keystore</span></span><br><span class="line">        <span class="comment">// pass</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">pass</span> <span class="operator">=</span> password; <span class="comment">// Provide Keystore password</span></span><br><span class="line">        <span class="comment">// 加解密密钥对的别名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">signatureKeyAlias</span> <span class="operator">=</span> jksAlise; <span class="comment">// Provide alias name of your private key</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**Steps for creation of JWT Token and signing with your RSA private key**/</span></span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>[] keystorePassword = pass.toCharArray();</span><br><span class="line">        <span class="type">KeyStore</span> <span class="variable">keystore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;JKS&quot;</span>);</span><br><span class="line">        keystore.load(keyStoreData, pass.toCharArray());</span><br><span class="line">        <span class="comment">// 获取私钥</span></span><br><span class="line">        <span class="type">PrivateKey</span> <span class="variable">key</span> <span class="operator">=</span> (PrivateKey) keystore.getKey(signatureKeyAlias, keystorePassword);</span><br><span class="line">        <span class="comment">// 签名器</span></span><br><span class="line">        RsaSHA256Signer signer;</span><br><span class="line">        signer = <span class="keyword">new</span> <span class="title class_">RsaSHA256Signer</span>(<span class="string">&quot;SCB&quot;</span>, <span class="literal">null</span>, (RSAPrivateKey) key);</span><br><span class="line">        <span class="comment">// 使用签名器构造jwt对象</span></span><br><span class="line">        <span class="type">JsonToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonToken</span>(signer);</span><br><span class="line">        <span class="type">long</span> <span class="variable">issueTime</span> <span class="operator">=</span> currentTimeMillis();</span><br><span class="line">        token.setParam(JTI_KEY, UUID.randomUUID().toString());</span><br><span class="line">        token.setAudience(AUDIENCE);</span><br><span class="line">        token.setIssuedAt(<span class="keyword">new</span> <span class="title class_">Instant</span>(issueTime));</span><br><span class="line">        token.setExpiration(<span class="keyword">new</span> <span class="title class_">Instant</span>(issueTime + TOKEN_TIMEOUT_DURATION));</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        json.put(<span class="string">&quot;enableWebHook&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        json.put(<span class="string">&quot;webHookUrl&quot;</span>, webhookUrl);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Value of content and key can be found in activationKey.json</span></span><br><span class="line"></span><br><span class="line">        item.put(<span class="string">&quot;content&quot;</span>,</span><br><span class="line">                bankProvidedContent);</span><br><span class="line">        item.put(<span class="string">&quot;key&quot;</span>,</span><br><span class="line">                bankProvideKey);</span><br><span class="line">        json.put(<span class="string">&quot;activationKey&quot;</span>, item);</span><br><span class="line">        <span class="comment">// 获取jwt对象存储报文的对象，并将数据存入</span></span><br><span class="line">        <span class="type">JsonObject</span> <span class="variable">payloadO</span> <span class="operator">=</span> token.getPayloadAsJsonObject();</span><br><span class="line">        <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">        <span class="type">JsonElement</span> <span class="variable">element</span> <span class="operator">=</span> gson.fromJson(json.toString(), JsonElement.class);</span><br><span class="line">        payloadO.add(PAYLOAD, element);</span><br><span class="line">        <span class="comment">// 输出签名前的报文</span></span><br><span class="line">        System.out.println(payloadO);</span><br><span class="line">        <span class="type">String</span> <span class="variable">x</span> <span class="operator">=</span> token.serializeAndSign();</span><br><span class="line">        <span class="comment">// 输出签名后的报文</span></span><br><span class="line">        System.out.println(x);           <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**Steps for creation of JWT Token and signing with your RSA private key**/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取使用证书和私钥初始化好的httpclient</span></span><br><span class="line">        <span class="type">CloseableHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> getHttpClientAuth();       <span class="comment">// Creating  secure connection between your side and bank by presenting signed certificate</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 指定请求端点</span></span><br><span class="line">        <span class="type">HttpPost</span> <span class="variable">httpPost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpPost</span>(target);    <span class="comment">// Provide API here</span></span><br><span class="line">        <span class="comment">// 放入签名后的jwt（base64的）</span></span><br><span class="line">        httpPost.setEntity(<span class="keyword">new</span> <span class="title class_">StringEntity</span>(x));                          <span class="comment">// passing JWT for https post call</span></span><br><span class="line">        <span class="comment">// 指定请求头</span></span><br><span class="line">        httpPost.addHeader(<span class="string">&quot;ResponseEncryptionType&quot;</span>, <span class="string">&quot;AES256Signed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送请求并获取响应</span></span><br><span class="line">        <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.execute(httpPost);                 <span class="comment">// Executing post request</span></span><br><span class="line">        <span class="comment">// 输出响应对象</span></span><br><span class="line">        System.out.println(response);</span><br><span class="line">        <span class="type">HttpEntity</span> <span class="variable">entity</span> <span class="operator">=</span> response.getEntity();</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">content</span> <span class="operator">=</span> entity.getContent();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="keyword">while</span> ((len = content.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(buf, <span class="number">0</span>, len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">responseString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(baos.toByteArray());</span><br><span class="line">        <span class="comment">// 输出响应体内容</span></span><br><span class="line">        System.out.println(responseString);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取https双向认证客户端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CloseableHttpClient <span class="title function_">getHttpClientAuth</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 双向认证需要的证书以及私钥也在同一个jks中</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(jksFilePath);   <span class="comment">// Path for jks</span></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SSLContextBuilder.create().loadTrustMaterial(file, password.toCharArray()).build(); <span class="comment">// Provide your keystore password here</span></span><br><span class="line">        <span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">connManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>();</span><br><span class="line">        connManager.setDefaultMaxPerRoute(<span class="number">10</span>);</span><br><span class="line">        connManager.setMaxTotal(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">HostnameVerifier</span> <span class="variable">allowAllHosts</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NoopHostnameVerifier</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>[] keyStorePassword = password.toCharArray();    <span class="comment">// Provide your keystore password here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">keyStoreData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(jksFilePath)) &#123;           <span class="comment">// Path for jks</span></span><br><span class="line">            <span class="type">KeyStore</span> <span class="variable">keyStore</span> <span class="operator">=</span> KeyStore.getInstance(<span class="string">&quot;JKS&quot;</span>);</span><br><span class="line">            keyStore.load(keyStoreData, keyStorePassword);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> safeHttpsBuilder(keyStore, password, HttpClients.custom()).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpClientBuilder <span class="title function_">safeHttpsBuilder</span><span class="params">(KeyStore keyStore, String clientCertPassword,</span></span><br><span class="line"><span class="params">                                                     HttpClientBuilder httpClientBuilder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取jks中存储的证书</span></span><br><span class="line">            <span class="type">X509Certificate</span> <span class="variable">cert</span> <span class="operator">=</span> (X509Certificate) keyStore.getCertificate(<span class="string">&quot;1&quot;</span>);    <span class="comment">// Provide alis name of signed certificate. By default its value is 1</span></span><br><span class="line">            <span class="keyword">if</span> (cert == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KeyManagementException</span>(</span><br><span class="line">                        <span class="string">&quot;No key alias &#x27;&quot;</span> + <span class="string">&quot;CLIENT_CERT_ALIAS&quot;</span> + <span class="string">&quot;&#x27; found in key store, cannot authenticate to server&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sslContext = SSLContexts.custom()</span><br><span class="line">            <span class="comment">// 获取证书对应的私钥</span></span><br><span class="line">                    .loadKeyMaterial(keyStore, clientCertPassword.toCharArray(), <span class="keyword">new</span> <span class="title class_">PrivateKeyStrategy</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> String <span class="title function_">chooseAlias</span><span class="params">(Map&lt;String, PrivateKeyDetails&gt; aliases, Socket socket)</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    .build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">SSLConnectionSocketFactory</span> <span class="variable">sslConnectionSocketFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SSLConnectionSocketFactory</span>(sslContext,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;TLSv1.2&quot;</span>, <span class="string">&quot;TLSv1.1&quot;</span>&#125;, <span class="literal">null</span>, SSLConnectionSocketFactory.STRICT_HOSTNAME_VERIFIER);</span><br><span class="line"></span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; registry = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                .register(<span class="string">&quot;https&quot;</span>, sslConnectionSocketFactory).register(<span class="string">&quot;http&quot;</span>, <span class="keyword">new</span> <span class="title class_">PlainConnectionSocketFactory</span>())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="type">PoolingHttpClientConnectionManager</span> <span class="variable">connectionManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolingHttpClientConnectionManager</span>(registry);</span><br><span class="line"></span><br><span class="line">        connectionManager.setMaxTotal(<span class="number">40</span>);</span><br><span class="line">        connectionManager.setDefaultMaxPerRoute(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpClientBuilder</span> <span class="variable">x</span> <span class="operator">=</span> httpClientBuilder.setConnectionManager(connectionManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// return x.setProxy(new HttpHost(&quot;10.239.9.190&quot;, 443)); // Give proxy if required</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%8A%A0%E5%AF%86/">加密</a></div><div class="post_share"><div class="social-share" data-image="/assets/img/tx.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/07/15/%E7%BB%8F%E9%AA%8C/jmeter/jmeter/" title="jmeter"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">jmeter</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/22/%E7%BB%8F%E9%AA%8C/%E7%99%BE%E5%BA%A6%E5%8D%83%E5%B8%86%E5%A4%A7%E6%A8%A1%E5%9E%8BErnieSpeed%E4%BD%BF%E7%94%A8/%E7%99%BE%E5%BA%A6%E5%8D%83%E5%B8%86%E5%A4%A7%E6%A8%A1%E5%9E%8BErnieSpeed%E4%BD%BF%E7%94%A8/" title="百度千帆大模型ErnieSpeed使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">百度千帆大模型ErnieSpeed使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2025/09/21/%E7%AC%94%E8%AE%B0/JASYPT/JASYPT/" title="JASYPT"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-21</div><div class="title">JASYPT</div></div></a></div><div><a href="/2024/03/03/%E7%AC%94%E8%AE%B0/%E5%B0%86%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E5%88%B0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E4%B8%AD/%E5%B0%86%E6%96%87%E4%BB%B6%E5%8A%A0%E5%AF%86%E5%88%B0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%E4%B8%AD/" title="将文件加密到图片文件中"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-03</div><div class="title">将文件加密到图片文件中</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/assets/img/tx.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Boranget</div><div class="author-info__description">整理的一些笔记和平时的一些经验</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">198</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">206</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Boranget"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">笔记分类是一些看书或者网课做的笔记，经验分类一般是平时碰到的问题或者折腾的一些小东西。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">记录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PGP"><span class="toc-number">2.</span> <span class="toc-text">PGP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PGP%E7%AD%BE%E5%90%8D"><span class="toc-number">2.1.</span> <span class="toc-text">PGP签名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PGP%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-number">2.2.</span> <span class="toc-text">PGP加解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GPG%E7%94%9F%E6%88%90PGP%E5%AF%86%E9%92%A5%E5%AF%B9"><span class="toc-number">2.3.</span> <span class="toc-text">GPG生成PGP密钥对</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8GPG%E5%B7%A5%E5%85%B7%E5%8A%A0%E8%A7%A3%E5%AF%86"><span class="toc-number">2.4.</span> <span class="toc-text">使用GPG工具加解密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8java%E8%BF%9B%E8%A1%8CPGP%E5%86%85%E5%AE%B9%E7%9A%84%E5%8A%A0%E8%A7%A3%E5%AF%86%E5%92%8C%E7%AD%BE%E9%AA%8C%E7%AD%BE"><span class="toc-number">2.5.</span> <span class="toc-text">使用java进行PGP内容的加解密和签验签</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%90%8D%E8%AF%8D"><span class="toc-number">3.</span> <span class="toc-text">相关名词</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#keytool%E7%94%9F%E6%88%90rsa%E5%AF%86%E9%92%A5%E5%AF%B9%E5%B9%B6%E5%AD%98%E5%82%A8%E5%88%B0jks%E4%B8%AD"><span class="toc-number">4.</span> <span class="toc-text">keytool生成rsa密钥对并存储到jks中</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BAjks%E4%B8%AD%E5%AD%98%E5%82%A8%E7%9A%84%E5%AF%86%E9%92%A5"><span class="toc-number">4.1.</span> <span class="toc-text">显示jks中存储的密钥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8Ejks%E4%B8%AD%E5%AF%BC%E5%87%BA%E8%AF%81%E4%B9%A6"><span class="toc-number">4.2.</span> <span class="toc-text">从jks中导出证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E8%AF%81%E4%B9%A6%E4%B8%AD%E5%AF%BC%E5%87%BA%E5%85%AC%E9%92%A5"><span class="toc-number">4.3.</span> <span class="toc-text">从证书中导出公钥</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSL%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81"><span class="toc-number">5.</span> <span class="toc-text">SSL双向认证</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/28/%E7%BB%8F%E9%AA%8C/%E9%BB%91%E7%A5%9E%E8%AF%9D%E7%A0%B4%E8%A7%A3%E7%89%88%E8%BF%90%E8%A1%8C/%E9%BB%91%E7%A5%9E%E8%AF%9D%E7%A0%B4%E8%A7%A3%E7%89%88%E8%BF%90%E8%A1%8C/" title="黑神话破解版运行">黑神话破解版运行</a><time datetime="2026-01-28T07:51:40.000Z" title="更新于 2026-01-28 15:51:40">2026-01-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/11/%E7%AC%94%E8%AE%B0/mi6x%E7%9B%B4%E4%BE%9B%E7%94%B5/mi6x%E7%9B%B4%E4%BE%9B%E7%94%B5/" title="mi6x直供电">mi6x直供电</a><time datetime="2026-01-11T15:35:19.000Z" title="更新于 2026-01-11 23:35:19">2026-01-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/07/%E7%AC%94%E8%AE%B0/win11%E5%90%AF%E5%8A%A8%E8%87%AA%E5%8A%A8%E6%89%93%E5%BC%80%E7%83%AD%E7%82%B9/win11%E5%90%AF%E5%8A%A8%E8%87%AA%E5%8A%A8%E6%89%93%E5%BC%80%E7%83%AD%E7%82%B9/" title="win11启动自动打开热点">win11启动自动打开热点</a><time datetime="2026-01-07T02:35:19.000Z" title="更新于 2026-01-07 10:35:19">2026-01-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/01/07/%E7%AC%94%E8%AE%B0/%E6%8A%93%E5%8F%96B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E5%BC%B9%E5%B9%95/%E6%8A%93%E5%8F%96B%E7%AB%99%E7%9B%B4%E6%92%AD%E9%97%B4%E5%BC%B9%E5%B9%95/" title="抓取B站直播间弹幕">抓取B站直播间弹幕</a><time datetime="2026-01-07T02:35:19.000Z" title="更新于 2026-01-07 10:35:19">2026-01-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/20/%E7%AC%94%E8%AE%B0/Dart/Dart/" title="Dart">Dart</a><time datetime="2025-12-20T02:35:19.000Z" title="更新于 2025-12-20 10:35:19">2025-12-20</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2026 By Boranget</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>